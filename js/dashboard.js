document.addEventListener("DOMContentLoaded", async () => {
    await loadStockData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    await DashboardCheckRight();

// ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ
setInterval(async () => {
    console.log("üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...");
    await loadStockData();
    await DashboardCheckRight();
}, 300000); // 300,000ms = 5 ‡∏ô‡∏≤‡∏ó‡∏µ
});
// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á
async function loadStockData() {
try {
    const response = await fetch("/api/get-stock-status2");  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API
    const result = await response.json();  // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô JSON
    // console.log("‚úÖ ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å API:", result);  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà API ‡∏™‡πà‡∏á‡∏°‡∏≤
    // console.table(result.data);  // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô Console

    if (!result.success || !result.data || result.data.length === 0) {
        document.querySelector("#stockSummaryTable tbody").innerHTML = "<tr><td colspan='4' class='text-center'>‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>";
        return;
    }

    updateStockTable(result.data);  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á
} catch (error) {
    console.error("‚ö†Ô∏è Error loading stock status:", error);
}
}       
    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    function updateStockTable(data) {
        if (!Array.isArray(data)) {
            console.error("‚ùå Data ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà array:", data);
            return;
        }
    const tableBody = document.querySelector("#stockSummaryTable tbody");
    tableBody.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà

    data.forEach(row => {
        if (!row.STATUS_NAME) return; // ‚úÖ ‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"
         // ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        let bgColor = "";
        if (row.STATUS_NAME === "‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°") {
            bgColor = "background-color: yellow;";
        } else if (row.STATUS_NAME === "‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢") {
            bgColor = "background-color: lightgreen;";
        }
        const tr = document.createElement("tr");

        tr.innerHTML = `
            <td>${row.DI_REF || '-'}</td>
            <td>${row.SKU_NAME || '-'}</td>
            <td>${row.LATEST_PREPARE_QTY !== null ? row.LATEST_PREPARE_QTY : '-'}</td>
            <td style="${bgColor}">${row.STATUS_NAME}</td>
        `;

        tableBody.appendChild(tr);
    });
}
    

document.getElementById('logoutButton').addEventListener('click', function() {
    localStorage.clear();
    window.location.href = '/';
});

window.onload = function() {
    const CheckUser = localStorage.getItem('username');
    if (CheckUser === null || CheckUser.trim() === '') {
        window.location.href = '/';
    }
    document.querySelector("#userDropdown span").textContent = CheckUser;
};
async function DashboardCheckRight() {
    
    const rights = localStorage.getItem("user_rights");
    const username = localStorage.getItem("user_rusernameights");
    
    try {
        
    

        if (rights == 'user') {
            document.getElementById("Report").hidden = true;
            return;
        }


    } catch (error) {
        console.error("Error:", error);
    }
}
DashboardCheckRight();